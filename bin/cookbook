#!/usr/bin/env node

const path = require('path');
const fs = require('fs');
const yaml = require('js-yaml');
const Promise = require('bluebird');

const usage = require('./usage');
const cookbook = require('../lib/cookbook');
const UsageError = require('../lib/usage-error');
const args = require('minimist')(process.argv.slice(2));

args.force = args.force || args.f;

if (args.help) {
  return usage();
}

const configFile = args._;

if (!configFile.length) {
  configFile.push('.kube.yaml');
}

const config = configFile.reduce((list, file) => {
  const type = path.extname(file);
  const filePath = path.resolve(process.cwd(), file);
  try {
    if (type === '.js' || type === '.json') {
      return list.concat(require(filePath));
    } else if (type === '.yaml' || type === '.yml') {
      const content = fs.readFileSync(filePath).toString();
      return list.concat(yaml.safeLoad(content));
    }
  } catch (e) {
    console.log(e);
    throw new Error(`Could not read configuration from ${filePath}`);
  }
}, []);

const defaults = {
  recipe: 'webapp'
};

Promise.mapSeries(config, c => {
  const options = Object.assign({}, defaults, c, args);
  if (config.length > 1) {
    options.prefix = options.prefix || `${options.name}-`;
  }
  return cookbook(options)
})
  .catch(e => {
    if (e instanceof UsageError) {
      usage(e.message);
    } else {
      console.error(e);
    }
    process.exit(1);
  });
