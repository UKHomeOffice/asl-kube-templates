#!/usr/bin/env node

const path = require('path');
const fs = require('fs');
const yaml = require('js-yaml');
const Promise = require('bluebird');

const usage = require('./usage');
const cookbook = require('../lib/cookbook');
const UsageError = require('../lib/usage-error');
const args = require('minimist')(process.argv.slice(2));

args.force = args.force || args.f;

if (args.help) {
  return usage();
}

let config;
const configFile = args._[0] || '.kube.yaml';

if (configFile) {
  const type = path.extname(configFile);
  const filePath = path.resolve(process.cwd(), configFile);
  try {
    if (type === '.js' || type === '.json') {
      config = require(filePath);
    } else if (type === '.yaml' || type === '.yml') {
      const content = fs.readFileSync(filePath).toString();
      config = yaml.safeLoad(content);
    }
  } catch (e) {
    console.log(e);
    throw new Error(`Could not read configuration from ${filePath}`);
  }
}

const defaults = {
  recipe: 'webapp'
};

if (!Array.isArray(config)) {
  config = [config];
}

Promise.mapSeries(config, c => {
  const options = Object.assign({}, defaults, c, args);
  return cookbook(options)
})
  .catch(e => {
    if (e instanceof UsageError) {
      usage(e.message);
    } else {
      console.error(e);
    }
    process.exit(1);
  });
